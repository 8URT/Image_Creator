<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Layout Creator</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Template configuration from server
    const templateConfig = {{ template_config | tojson }};
  </script>

  <style>
    :root {
      --cool-steel: #8399a2;
      --cool-steel-2: #95a8b0;
      --cool-steel-3: #a7b7bd;
      --silver: #b9c6cb;
      --silver-2: #cad4d8;
      --alabaster-grey: #dce3e6;
      --platinum: #eef2f3;
    }
    
    /* Minimalist Design with Cool Steel Palette */
    body {
      background-color: var(--platinum);
      color: var(--cool-steel);
      font-weight: 300;
    }
    .gradient-bg {
      background: var(--platinum);
    }
    .bg-white {
      background-color: #ffffff;
      color: var(--cool-steel);
    }
    .text-gray-800 {
      color: var(--cool-steel);
      font-weight: 400;
    }
    .border-gray-200 {
      border-color: var(--silver-2);
    }
    .border-gray-300 {
      border-color: var(--silver);
    }
    .border-gray-400 {
      border-color: var(--cool-steel-3);
    }
    .text-gray-600 {
      color: var(--cool-steel-2);
      font-weight: 400;
    }
    .text-gray-500 {
      color: var(--cool-steel-3);
    }
    .bg-gray-100 {
      background-color: var(--alabaster-grey);
      color: var(--cool-steel);
    }
    .bg-gray-200 {
      background-color: var(--alabaster-grey);
    }
    .hover\:bg-gray-200:hover {
      background-color: var(--silver-2);
    }
    .hover\:bg-gray-300:hover {
      background-color: var(--silver);
    }
    .text-blue-600 {
      color: var(--cool-steel);
    }
    .focus\:border-blue-500 {
      border-color: var(--cool-steel-2);
    }
    .focus\:ring-blue-100 {
      box-shadow: 0 0 0 1px var(--cool-steel-3);
    }
    .hover\:border-blue-500 {
      border-color: var(--cool-steel-2);
    }
    .hover\:bg-blue-50 {
      background-color: var(--alabaster-grey);
    }
    /* Minimalist buttons */
    .import-button, .generate-button {
      background: var(--cool-steel);
      color: #ffffff;
      border: 1px solid var(--cool-steel);
      font-weight: 500;
    }
    .import-button:hover, .generate-button:hover {
      background: var(--cool-steel-2);
      border-color: var(--cool-steel-2);
      transform: translateY(-1px);
    }
    .download-button {
      background: var(--silver);
      color: var(--cool-steel);
      border: 1px solid var(--silver);
      font-weight: 500;
    }
    .download-button:hover {
      background: var(--cool-steel-3);
      border-color: var(--cool-steel-3);
      transform: translateY(-1px);
    }
    .ring-blue-500 {
      box-shadow: 0 0 0 3px rgba(102, 170, 255, 0.5);
    }

    /* Canvas specific styles */
    #canvas {
      max-width: 100%;
      height: auto;
      background-color: #ffffff;
      border: 1px solid var(--silver-2);
    }

    /* Style for the drag-over state */
    .drag-over {
        border-color: var(--cool-steel) !important;
        background-color: var(--alabaster-grey) !important;
        color: var(--cool-steel) !important;
    }

    /* Range slider minimalist styles */
    input[type="range"] {
        background-color: var(--alabaster-grey);
    }
    input[type="range"]::-webkit-slider-thumb {
      background: var(--cool-steel);
      border: 1px solid var(--cool-steel-2);
    }
    input[type="range"]::-moz-range-thumb {
      background: var(--cool-steel);
      border: 1px solid var(--cool-steel-2);
    }
    input[type="range"]::-ms-thumb {
      background: var(--cool-steel);
      border: 1px solid var(--cool-steel-2);
    }
    /* Input field background and text */
    input[type="text"], input[type="number"], textarea, select {
      background-color: #ffffff;
      color: var(--cool-steel);
      border-color: var(--silver);
      font-weight: 400;
    }
    input[type="text"]::placeholder, textarea::placeholder {
      color: var(--cool-steel-3);
    }
    /* Minimalist drop zone */
    #imageDropZone {
        background: var(--alabaster-grey);
        border-color: var(--silver);
        border-width: 2px;
    }
    #imageDropZone:hover {
        border-color: var(--cool-steel-2);
        background: var(--silver-2);
        transform: translateY(-1px);
    }
    /* Minimalist format button styles */
    .format-button {
      background: var(--alabaster-grey);
      color: var(--cool-steel);
      border: 1px solid var(--silver-2);
      font-weight: 500;
    }
    .format-button:hover {
      background: var(--silver-2);
      border-color: var(--silver);
    }
    .format-button.active {
      background: var(--cool-steel);
      border-color: var(--cool-steel);
      color: #ffffff;
    }
    #formatSocial.active {
      background: #457b9d;
      border-color: #457b9d;
      color: #ffffff;
    }
    #formatStory.active {
      background: #7209b7;
      border-color: #7209b7;
      color: #ffffff;
    }
    #formatWebsite.active {
      background: #e63946;
      border-color: #e63946;
      color: #ffffff;
    }
    .grid-template-button {
      background: var(--alabaster-grey);
      color: var(--cool-steel);
      border: 1px solid var(--silver-2);
      font-weight: 500;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 12px;
    }
    .grid-template-button:hover {
      background: var(--silver-2);
      border-color: var(--silver);
    }
    .grid-template-button.active {
      background: var(--cool-steel);
      border-color: var(--cool-steel);
      color: #ffffff;
    }
    .thumbnail-wrapper {
      position: relative;
      display: inline-block;
    }
    .image-thumbnail {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border: 2px solid var(--silver);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .image-thumbnail:hover {
      border-color: var(--cool-steel);
      transform: scale(1.05);
    }
    .image-thumbnail.selected {
      border-color: var(--cool-steel);
      border-width: 3px;
      box-shadow: 0 0 0 2px var(--cool-steel-3);
    }
    .delete-thumbnail-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 24px;
      height: 24px;
      background: #e63946;
      color: white;
      border: 2px solid white;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.2s ease;
      z-index: 10;
    }
    .delete-thumbnail-btn:hover {
      background: #c1121f;
      transform: scale(1.1);
    }
    .slot-highlight {
      stroke: var(--cool-steel);
      stroke-width: 3;
      fill: rgba(131, 153, 162, 0.1);
    }
    
    /* Navigation Menu */
    .top-nav {
      height: 70px;
      background-color: #8399a2;
      position: sticky;
      top: 0;
      z-index: 100;
      padding-top: 15px;
    }
    .nav-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }
    .nav-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .nav-logo {
      height: 40px;
      width: auto;
    }
    .nav-title {
      font-size: 18px;
      font-weight: 500;
      color: #ffffff;
      margin: 0;
    }
    .nav-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .nav-icon-button {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background-color: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #ffffff;
      text-decoration: none;
    }
    .nav-icon-button:hover {
      background-color: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
    }
    .nav-icon-button svg {
      width: 20px;
      height: 20px;
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .top-nav {
        height: 60px;
        padding-top: 12px;
      }
      .nav-logo {
        height: 32px;
      }
      .nav-title {
        font-size: 16px;
      }
      .nav-icon-button {
        width: 36px;
        height: 36px;
      }
      .nav-icon-button svg {
        width: 18px;
        height: 18px;
      }
      .max-w-5xl.mx-auto.px-4 {
        padding-left: 8px;
        padding-right: 8px;
      }
      button, .nav-icon-button {
        min-height: 44px;
      }
      input[type="range"]::-webkit-slider-thumb {
        width: 20px;
        height: 20px;
      }
      input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
      }
      input[type="range"]::-ms-thumb {
        width: 20px;
        height: 20px;
      }
      body {
        overflow-x: hidden;
      }
      .flex.justify-center.items-start {
        padding: 8px 0;
      }
      #canvas {
        width: 100%;
        height: auto;
      }
      .image-thumbnail {
        width: 60px;
        height: 60px;
      }
      .delete-thumbnail-btn {
        width: 20px;
        height: 20px;
        font-size: 12px;
        top: -6px;
        right: -6px;
      }
    }
  </style>
</head>
<body class="min-h-screen gradient-bg font-['Fira_Sans']">
  <!-- Top Navigation Menu -->
  <nav class="top-nav">
    <div class="max-w-5xl mx-auto px-4 w-full">
      <div class="nav-container">
        <div class="nav-left">
          <img src="{{ url_for('static', filename='assets/mlinfo_lm.png') }}" alt="Logo" class="nav-logo">
          <h1 class="nav-title">Layout creator</h1>
        </div>
        <div class="nav-right">
          <a href="{{ url_for('main.image_creator') }}" class="nav-icon-button" title="Image Creator">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </a>
          {% if current_user.is_authenticated and current_user.is_admin %}
          <a href="{{ url_for('admin.users') }}" class="nav-icon-button" title="Admin Panel">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </a>
          {% endif %}
          <a href="{{ url_for('auth.logout') }}" class="nav-icon-button" title="Logout">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-5xl mx-auto px-4 pt-4 sm:pt-8 pb-4">
    <div class="rounded-lg overflow-hidden">
      <div class="grid md:grid-cols-[1fr_320px] gap-2 sm:gap-4 p-2 sm:p-4">
        <div class="flex justify-center items-start">
          <canvas id="canvas" width="1000" height="1250" class="rounded shadow-sm bg-white"></canvas>
        </div>

        <div class="bg-white p-3 sm:p-5 rounded-lg shadow-sm border border-gray-200">
          <div class="mb-4">
            <div class="flex gap-2 mb-2">
              <button type="button" id="formatSocial" class="flex-1 px-4 py-3 sm:py-2 rounded font-bold transition-all duration-300 text-sm format-button active" data-format="social">
                Post
              </button>
              <button type="button" id="formatStory" class="flex-1 px-4 py-3 sm:py-2 rounded font-bold transition-all duration-300 text-sm format-button" data-format="story">
                Story
              </button>
              <button type="button" id="formatWebsite" class="flex-1 px-4 py-3 sm:py-2 rounded font-bold transition-all duration-300 text-sm format-button" data-format="website">
                Website
              </button>
            </div>
          </div>

          <div class="mb-4">
            <label class="block font-bold text-gray-600 mb-2 text-xs">Grid Layout:</label>
            <div class="grid grid-cols-2 gap-2" id="gridTemplateButtons">
              <!-- Grid template buttons will be generated by JavaScript -->
            </div>
          </div>

          <div id="imageDropZone" onclick="document.getElementById('imageUpload').click()" class="border-2 border-dashed border-gray-400 rounded p-4 sm:p-8 text-center mb-4 transition-all duration-300 cursor-pointer hover:border-gray-500 hover:shadow-sm hover:-translate-y-1 flex flex-col items-center justify-center min-h-[120px]">
            <input type="file" id="imageUpload" accept="image/*" multiple class="hidden" />
            <p id="dropZoneText" class="text-base sm:text-lg font-bold text-gray-600 mb-3">Select or Drop Images (up to 6)</p>
            <button type="button" onclick="event.stopPropagation(); document.getElementById('imageUpload').click();" class="import-button text-white px-4 py-3 sm:py-2 rounded font-bold transition-all duration-300 hover:-translate-y-1 text-sm">
              Click to Select Images
            </button>
          </div>

          <div id="imageThumbnails" class="mb-4 hidden">
            <label class="block font-bold text-gray-600 mb-2 text-xs">Uploaded Images:</label>
            <div class="flex flex-wrap gap-2" id="thumbnailContainer">
              <!-- Thumbnails will be generated by JavaScript -->
            </div>
            <p class="text-xs text-gray-500 mt-2">Click an image to select it, then click a grid slot to assign it</p>
          </div>

          <div id="imagePositionControls" class="mb-4 hidden">
            <label class="block font-bold text-gray-600 mb-2 text-xs">Image Adjustments (for selected slot):</label>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3 mb-4">
              <div>
                <label for="imageOffsetX" class="block font-bold text-gray-600 mb-1 text-xs text-center">
                  ‚Üê ‚Üí
                </label>
                <input type="range" id="imageOffsetX" min="-500" max="500" value="0" class="w-full h-2 bg-gray-200 rounded appearance-none cursor-pointer">
                <div class="text-center text-xs text-gray-500 mt-1" id="imageOffsetXValue">0</div>
              </div>
              <div>
                <label for="imageOffsetY" class="block font-bold text-gray-600 mb-1 text-xs text-center">
                  ‚Üë ‚Üì
                </label>
                <input type="range" id="imageOffsetY" min="-500" max="500" value="0" class="w-full h-2 bg-gray-200 rounded appearance-none cursor-pointer">
                <div class="text-center text-xs text-gray-500 mt-1" id="imageOffsetYValue">0</div>
              </div>
              <div>
                <label for="imageZoom" class="block font-bold text-gray-600 mb-1 text-xs text-center">
                  - üîç +
                </label>
                <input type="range" id="imageZoom" min="1" max="300" value="100" class="w-full h-2 bg-gray-200 rounded appearance-none cursor-pointer">
                <div class="text-center text-xs text-gray-500 mt-1" id="imageZoomValue">100%</div>
              </div>
              <div class="flex items-end">
                <button type="button" id="resetImageControls" class="w-full h-8 flex items-center justify-center bg-gray-200 hover:bg-gray-300 rounded transition-all duration-300 cursor-pointer" title="Reset to defaults">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <div class="space-y-4 mb-4">
            <div>
              <label class="block font-bold text-gray-600 mb-1 text-xs">
                Spacing: <span id="spacingValue">0</span>px
              </label>
              <input type="range" id="spacingSlider" min="0" max="50" value="0" step="1" class="w-full h-2 bg-gray-200 rounded appearance-none cursor-pointer" />
            </div>

            <div>
              <label class="block font-bold text-gray-600 mb-1 text-xs">
                Border Width: <span id="borderWidthValue">0</span>px
              </label>
              <input type="range" id="borderWidthSlider" min="0" max="10" value="0" step="1" class="w-full h-2 bg-gray-200 rounded appearance-none cursor-pointer" />
            </div>

            <div>
              <label class="block font-bold text-gray-600 mb-1 text-xs">Border Color:</label>
              <input type="color" id="borderColorPicker" value="#000000" class="w-full h-8 border-2 border-gray-300 rounded-md cursor-pointer" />
            </div>

            <div>
              <label class="block font-bold text-gray-600 mb-1 text-xs">Background Color:</label>
              <input type="color" id="backgroundColorPicker" value="#FFFFFF" class="w-full h-8 border-2 border-gray-300 rounded-md cursor-pointer" />
            </div>

            <div>
              <label class="block font-bold text-gray-600 mb-1 text-xs">
                Rounded Corners: <span id="roundedCornersValue">0</span>px
              </label>
              <input type="range" id="roundedCornersSlider" min="0" max="50" value="0" step="1" class="w-full h-2 bg-gray-200 rounded appearance-none cursor-pointer" />
            </div>

            <div>
              <label class="block font-bold text-gray-600 mb-1 text-xs">Image Fit:</label>
              <select id="imageFitSelect" class="w-full px-3 py-2 border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-100 transition-all duration-300 text-sm">
                <option value="cover" selected>Cover (Fill slot)</option>
                <option value="contain">Contain (Fit within slot)</option>
              </select>
            </div>
          </div>

          <div class="flex gap-3 pt-4">
            <button onclick="drawLayoutCanvas()" class="generate-button flex-1 text-white px-4 py-3 sm:py-2 rounded font-bold transition-all duration-300 hover:-translate-y-1 hover:shadow-sm text-sm">Generate Layout</button>
            <button onclick="downloadLayout()" class="download-button flex-1 text-white px-4 py-3 sm:py-2 rounded font-bold transition-all duration-300 hover:-translate-y-1 hover:shadow-sm text-sm">Download Image</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const imageInput = document.getElementById('imageUpload');
    
    // Format state: 'social', 'story', or 'website'
    let currentFormat = 'social';
    const SOCIAL_FORMAT = { width: 1000, height: 1250 };
    const STORY_FORMAT = { width: 1080, height: 1920 };
    const WEBSITE_FORMAT = { width: 1000, height: 500 };

    // Grid templates
    const GRID_TEMPLATES = {
      '2-col': {
        name: '2 Columns',
        slots: [
          { x: 0, y: 0, width: 0.5, height: 1 },
          { x: 0.5, y: 0, width: 0.5, height: 1 }
        ]
      },
      '2-rows': {
        name: '2 Rows',
        slots: [
          { x: 0, y: 0, width: 1, height: 0.5 },
          { x: 0, y: 0.5, width: 1, height: 0.5 }
        ]
      },
      '2x2': {
        name: '2x2 Grid',
        slots: [
          { x: 0, y: 0, width: 0.5, height: 0.5 },
          { x: 0.5, y: 0, width: 0.5, height: 0.5 },
          { x: 0, y: 0.5, width: 0.5, height: 0.5 },
          { x: 0.5, y: 0.5, width: 0.5, height: 0.5 }
        ]
      },
      '3-rows': {
        name: '3 Rows',
        slots: [
          { x: 0, y: 0, width: 1, height: 0.333 },
          { x: 0, y: 0.333, width: 1, height: 0.333 },
          { x: 0, y: 0.666, width: 1, height: 0.334 }
        ]
      },
      '3-column': {
        name: '3 Columns',
        slots: [
          { x: 0, y: 0, width: 0.333, height: 1 },
          { x: 0.333, y: 0, width: 0.333, height: 1 },
          { x: 0.666, y: 0, width: 0.334, height: 1 }
        ]
      },
      '4-rows': {
        name: '4 Rows',
        slots: [
          { x: 0, y: 0, width: 1, height: 0.25 },
          { x: 0, y: 0.25, width: 1, height: 0.25 },
          { x: 0, y: 0.5, width: 1, height: 0.25 },
          { x: 0, y: 0.75, width: 1, height: 0.25 }
        ]
      },
      '4-col': {
        name: '4 Columns',
        slots: [
          { x: 0, y: 0, width: 0.25, height: 1 },
          { x: 0.25, y: 0, width: 0.25, height: 1 },
          { x: 0.5, y: 0, width: 0.25, height: 1 },
          { x: 0.75, y: 0, width: 0.25, height: 1 }
        ]
      },
      '5-rows': {
        name: '5 Rows',
        slots: [
          { x: 0, y: 0, width: 1, height: 0.2 },
          { x: 0, y: 0.2, width: 1, height: 0.2 },
          { x: 0, y: 0.4, width: 1, height: 0.2 },
          { x: 0, y: 0.6, width: 1, height: 0.2 },
          { x: 0, y: 0.8, width: 1, height: 0.2 }
        ]
      },
      '5-col': {
        name: '5 Columns',
        slots: [
          { x: 0, y: 0, width: 0.2, height: 1 },
          { x: 0.2, y: 0, width: 0.2, height: 1 },
          { x: 0.4, y: 0, width: 0.2, height: 1 },
          { x: 0.6, y: 0, width: 0.2, height: 1 },
          { x: 0.8, y: 0, width: 0.2, height: 1 }
        ]
      },
      '1+2': {
        name: '1+2 Layout',
        slots: [
          { x: 0, y: 0, width: 0.5, height: 1 },
          { x: 0.5, y: 0, width: 0.5, height: 0.5 },
          { x: 0.5, y: 0.5, width: 0.5, height: 0.5 }
        ]
      },
      '2+1': {
        name: '2+1 Layout',
        slots: [
          { x: 0, y: 0, width: 0.5, height: 0.5 },
          { x: 0, y: 0.5, width: 0.5, height: 0.5 },
          { x: 0.5, y: 0, width: 0.5, height: 1 }
        ]
      },
      '6-grid': {
        name: '6 Grid',
        slots: [
          { x: 0, y: 0, width: 0.333, height: 0.5 },
          { x: 0.333, y: 0, width: 0.333, height: 0.5 },
          { x: 0.666, y: 0, width: 0.334, height: 0.5 },
          { x: 0, y: 0.5, width: 0.333, height: 0.5 },
          { x: 0.333, y: 0.5, width: 0.333, height: 0.5 },
          { x: 0.666, y: 0.5, width: 0.334, height: 0.5 }
        ]
      },
      'mosaic2': {
        name: 'Mosaic 2',
        slots: [
          { x: 0, y: 0, width: 0.333, height: 0.333 },
          { x: 0.333, y: 0, width: 0.667, height: 0.5 },
          { x: 0, y: 0.333, width: 0.333, height: 0.333 },
          { x: 0, y: 0.666, width: 0.333, height: 0.334 },
          { x: 0.333, y: 0.5, width: 0.333, height: 0.5 },
          { x: 0.666, y: 0.5, width: 0.334, height: 0.5 }
        ]
      }
    };

    let currentTemplate = '2-col';
    let uploadedImages = [];
    let imageAssignments = {}; // slotIndex -> imageIndex
    let imageAdjustments = {}; // slotIndex -> {offsetX, offsetY, zoom}
    let selectedImageIndex = null;
    let selectedSlotIndex = null; // Currently selected slot for adjustments
    let spacing = 0;
    let borderWidth = 0;
    let borderColor = '#000000';
    let backgroundColor = '#FFFFFF';
    let roundedCorners = 0;
    let imageFit = 'cover';

    // Initialize grid template buttons
    function initGridTemplates() {
      const container = document.getElementById('gridTemplateButtons');
      Object.keys(GRID_TEMPLATES).forEach((key, index) => {
        const template = GRID_TEMPLATES[key];
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'grid-template-button' + (index === 0 ? ' active' : '');
        button.textContent = template.name;
        button.dataset.template = key;
        button.onclick = () => selectTemplate(key);
        container.appendChild(button);
      });
    }

    function selectTemplate(templateKey) {
      currentTemplate = templateKey;
      document.querySelectorAll('.grid-template-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.template === templateKey) {
          btn.classList.add('active');
        }
      });
      // Clear assignments for slots that don't exist in new template
      const template = GRID_TEMPLATES[templateKey];
      Object.keys(imageAssignments).forEach(slotIndex => {
        if (parseInt(slotIndex) >= template.slots.length) {
          delete imageAssignments[slotIndex];
          delete imageAdjustments[slotIndex];
        }
      });
      if (selectedSlotIndex !== null && selectedSlotIndex >= template.slots.length) {
        selectedSlotIndex = null;
        updateImageControls();
      }
      drawLayoutCanvas();
    }

    function updateCanvasSize() {
      let format;
      if (currentFormat === 'social') {
        format = SOCIAL_FORMAT;
      } else if (currentFormat === 'story') {
        format = STORY_FORMAT;
      } else {
        format = WEBSITE_FORMAT;
      }
      
      canvas.width = format.width;
      canvas.height = format.height;
      drawLayoutCanvas();
    }

    // Format buttons
    const formatSocial = document.getElementById('formatSocial');
    const formatStory = document.getElementById('formatStory');
    const formatWebsite = document.getElementById('formatWebsite');

    formatSocial.addEventListener('click', () => {
      currentFormat = 'social';
      formatSocial.classList.add('active');
      formatStory.classList.remove('active');
      formatWebsite.classList.remove('active');
      updateCanvasSize();
    });

    formatStory.addEventListener('click', () => {
      currentFormat = 'story';
      formatStory.classList.add('active');
      formatSocial.classList.remove('active');
      formatWebsite.classList.remove('active');
      updateCanvasSize();
    });

    formatWebsite.addEventListener('click', () => {
      currentFormat = 'website';
      formatWebsite.classList.add('active');
      formatSocial.classList.remove('active');
      formatStory.classList.remove('active');
      updateCanvasSize();
    });

    // Image upload handling
    imageInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files).slice(0, 6);
      files.forEach(file => {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
              uploadedImages.push({
                file: file,
                dataUrl: event.target.result,
                image: img,
                width: img.width,
                height: img.height
              });
              updateThumbnails();
            };
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      });
    });

    // Drag and drop
    const dropZone = document.getElementById('imageDropZone');
    
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      const files = Array.from(e.dataTransfer.files).slice(0, 6 - uploadedImages.length);
      files.forEach(file => {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
              uploadedImages.push({
                file: file,
                dataUrl: event.target.result,
                image: img,
                width: img.width,
                height: img.height
              });
              updateThumbnails();
            };
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      });
    });

    function updateThumbnails() {
      const container = document.getElementById('thumbnailContainer');
      const thumbnailsDiv = document.getElementById('imageThumbnails');
      container.innerHTML = '';
      
      if (uploadedImages.length > 0) {
        thumbnailsDiv.classList.remove('hidden');
        uploadedImages.forEach((imgData, index) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'thumbnail-wrapper';
          
          const thumbnail = document.createElement('img');
          thumbnail.src = imgData.dataUrl;
          thumbnail.className = 'image-thumbnail' + (selectedImageIndex === index ? ' selected' : '');
          thumbnail.draggable = true;
          thumbnail.dataset.imageIndex = index;
          thumbnail.onclick = () => selectImage(index);
          thumbnail.ondragstart = (e) => {
            e.dataTransfer.setData('imageIndex', index);
            selectedImageIndex = index;
            updateThumbnails();
          };
          
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete-thumbnail-btn';
          deleteBtn.innerHTML = '√ó';
          deleteBtn.title = 'Delete image';
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deleteImage(index);
          };
          
          wrapper.appendChild(thumbnail);
          wrapper.appendChild(deleteBtn);
          container.appendChild(wrapper);
        });
      } else {
        thumbnailsDiv.classList.add('hidden');
      }
    }

    function deleteImage(index) {
      // Remove the image
      uploadedImages.splice(index, 1);
      
      // Clean up assignments - remove references to deleted image and adjust indices
      const newAssignments = {};
      const newAdjustments = {};
      Object.keys(imageAssignments).forEach(slotIndex => {
        const assignedIndex = imageAssignments[slotIndex];
        if (assignedIndex < index) {
          // Keep assignments for images before deleted one
          newAssignments[slotIndex] = assignedIndex;
          if (imageAdjustments[slotIndex]) {
            newAdjustments[slotIndex] = imageAdjustments[slotIndex];
          }
        } else if (assignedIndex > index) {
          // Adjust indices for images after deleted one
          newAssignments[slotIndex] = assignedIndex - 1;
          if (imageAdjustments[slotIndex]) {
            newAdjustments[slotIndex] = imageAdjustments[slotIndex];
          }
        }
        // Skip assignments to the deleted image (assignedIndex === index)
      });
      imageAssignments = newAssignments;
      imageAdjustments = newAdjustments;
      
      // Clear selection if deleted image was selected
      if (selectedImageIndex === index) {
        selectedImageIndex = null;
      } else if (selectedImageIndex > index) {
        selectedImageIndex = selectedImageIndex - 1;
      }
      
      updateThumbnails();
      drawLayoutCanvas();
    }

    function selectImage(index) {
      selectedImageIndex = selectedImageIndex === index ? null : index;
      updateThumbnails();
    }

    // Canvas click handler for assigning images or selecting slots
    canvas.addEventListener('click', (e) => {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = (e.clientX - rect.left) * scaleX;
      const y = (e.clientY - rect.top) * scaleY;
      
      const template = GRID_TEMPLATES[currentTemplate];
      const spacingPx = spacing;
      const canvasWidth = canvas.width;
      const canvasHeight = canvas.height;
      
      template.slots.forEach((slot, slotIndex) => {
        const slotX = slot.x * canvasWidth + spacingPx;
        const slotY = slot.y * canvasHeight + spacingPx;
        const slotWidth = slot.width * canvasWidth - spacingPx * 2;
        const slotHeight = slot.height * canvasHeight - spacingPx * 2;
        
        if (x >= slotX && x <= slotX + slotWidth && y >= slotY && y <= slotY + slotHeight) {
          if (selectedImageIndex !== null) {
            // Assign image to slot
            imageAssignments[slotIndex] = selectedImageIndex;
            if (!imageAdjustments[slotIndex]) {
              imageAdjustments[slotIndex] = { offsetX: 0, offsetY: 0, zoom: 100 };
            }
            selectedImageIndex = null;
            selectedSlotIndex = slotIndex;
            updateThumbnails();
            updateImageControls();
            drawLayoutCanvas();
          } else {
            // Select slot for adjustments
            selectedSlotIndex = selectedSlotIndex === slotIndex ? null : slotIndex;
            updateImageControls();
            drawLayoutCanvas();
          }
        }
      });
    });

    // Drag and drop on canvas
    canvas.addEventListener('dragover', (e) => {
      e.preventDefault();
    });

    canvas.addEventListener('drop', (e) => {
      e.preventDefault();
      const imageIndex = parseInt(e.dataTransfer.getData('imageIndex'));
      if (isNaN(imageIndex)) return;
      
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = (e.clientX - rect.left) * scaleX;
      const y = (e.clientY - rect.top) * scaleY;
      
      const template = GRID_TEMPLATES[currentTemplate];
      const spacingPx = spacing;
      const canvasWidth = canvas.width;
      const canvasHeight = canvas.height;
      
      template.slots.forEach((slot, slotIndex) => {
        const slotX = slot.x * canvasWidth + spacingPx;
        const slotY = slot.y * canvasHeight + spacingPx;
        const slotWidth = slot.width * canvasWidth - spacingPx * 2;
        const slotHeight = slot.height * canvasHeight - spacingPx * 2;
        
        if (x >= slotX && x <= slotX + slotWidth && y >= slotY && y <= slotY + slotHeight) {
          imageAssignments[slotIndex] = imageIndex;
          if (!imageAdjustments[slotIndex]) {
            imageAdjustments[slotIndex] = { offsetX: 0, offsetY: 0, zoom: 100 };
          }
          selectedSlotIndex = slotIndex;
          updateImageControls();
          drawLayoutCanvas();
        }
      });
    });

    function drawLayoutCanvas() {
      // Clear canvas with background color only (blank canvas)
      ctx.fillStyle = backgroundColor;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      const template = GRID_TEMPLATES[currentTemplate];
      const spacingPx = spacing;
      const canvasWidth = canvas.width;
      const canvasHeight = canvas.height;
      
      template.slots.forEach((slot, slotIndex) => {
        const slotX = slot.x * canvasWidth + spacingPx;
        const slotY = slot.y * canvasHeight + spacingPx;
        const slotWidth = slot.width * canvasWidth - spacingPx * 2;
        const slotHeight = slot.height * canvasHeight - spacingPx * 2;
        
        const hasImage = imageAssignments[slotIndex] !== undefined;
        const isSelected = selectedSlotIndex === slotIndex;
        
        // Draw border if enabled or if slot is selected
        if (borderWidth > 0 || isSelected || !hasImage) {
          ctx.strokeStyle = isSelected ? '#457b9d' : (hasImage ? borderColor : '#cccccc');
          ctx.lineWidth = isSelected ? 3 : (hasImage ? borderWidth : 2);
          ctx.setLineDash(isSelected ? [] : (hasImage ? [] : [5, 5]));
          if (roundedCorners > 0 && hasImage) {
            drawRoundedRect(ctx, slotX, slotY, slotWidth, slotHeight, roundedCorners);
            ctx.stroke();
          } else {
            ctx.strokeRect(slotX, slotY, slotWidth, slotHeight);
          }
          ctx.setLineDash([]);
        }
        
        // Draw slot number if no image assigned
        if (!hasImage) {
          ctx.save();
          ctx.fillStyle = '#8399a2';
          ctx.font = 'bold 48px Arial';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText((slotIndex + 1).toString(), slotX + slotWidth / 2, slotY + slotHeight / 2);
          ctx.restore();
        }
        
        // Draw image if assigned
        if (hasImage) {
          const imageIndex = imageAssignments[slotIndex];
          if (uploadedImages[imageIndex]) {
            const img = uploadedImages[imageIndex].image;
            const adjustments = imageAdjustments[slotIndex] || { offsetX: 0, offsetY: 0, zoom: 100 };
            
            ctx.save();
            
            // Always clip to slot boundaries to prevent overlap
            if (roundedCorners > 0) {
              ctx.beginPath();
              drawRoundedRect(ctx, slotX, slotY, slotWidth, slotHeight, roundedCorners);
              ctx.clip();
            } else {
              // Clip to rectangular slot boundaries
              ctx.beginPath();
              ctx.rect(slotX, slotY, slotWidth, slotHeight);
              ctx.clip();
            }
            
            let drawWidth, drawHeight, drawX, drawY;
            
            if (imageFit === 'cover') {
              const imgAspect = img.width / img.height;
              const slotAspect = slotWidth / slotHeight;
              
              if (imgAspect > slotAspect) {
                drawHeight = slotHeight;
                drawWidth = drawHeight * imgAspect;
                drawX = slotX - (drawWidth - slotWidth) / 2;
                drawY = slotY;
              } else {
                drawWidth = slotWidth;
                drawHeight = drawWidth / imgAspect;
                drawX = slotX;
                drawY = slotY - (drawHeight - slotHeight) / 2;
              }
            } else { // contain
              const imgAspect = img.width / img.height;
              const slotAspect = slotWidth / slotHeight;
              
              if (imgAspect > slotAspect) {
                drawWidth = slotWidth;
                drawHeight = drawWidth / imgAspect;
              } else {
                drawHeight = slotHeight;
                drawWidth = drawHeight * imgAspect;
              }
              drawX = slotX + (slotWidth - drawWidth) / 2;
              drawY = slotY + (slotHeight - drawHeight) / 2;
            }
            
            // Apply zoom
            const zoomFactor = adjustments.zoom / 100;
            drawWidth *= zoomFactor;
            drawHeight *= zoomFactor;
            
            // Apply offsets
            drawX += adjustments.offsetX;
            drawY += adjustments.offsetY;
            
            // Draw image (clipping will ensure it stays within slot boundaries)
            ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
            ctx.restore();
          }
        }
      });
    }

    function drawRoundedRect(ctx, x, y, width, height, radius) {
      ctx.beginPath();
      ctx.moveTo(x + radius, y);
      ctx.lineTo(x + width - radius, y);
      ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
      ctx.lineTo(x + width, y + height - radius);
      ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
      ctx.lineTo(x + radius, y + height);
      ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
      ctx.lineTo(x, y + radius);
      ctx.quadraticCurveTo(x, y, x + radius, y);
      ctx.closePath();
    }

    function updateImageControls() {
      const controlsDiv = document.getElementById('imagePositionControls');
      const offsetXInput = document.getElementById('imageOffsetX');
      const offsetYInput = document.getElementById('imageOffsetY');
      const zoomInput = document.getElementById('imageZoom');
      const offsetXValue = document.getElementById('imageOffsetXValue');
      const offsetYValue = document.getElementById('imageOffsetYValue');
      const zoomValue = document.getElementById('imageZoomValue');
      
      if (selectedSlotIndex !== null && imageAssignments[selectedSlotIndex] !== undefined) {
        controlsDiv.classList.remove('hidden');
        const adjustments = imageAdjustments[selectedSlotIndex] || { offsetX: 0, offsetY: 0, zoom: 100 };
        
        offsetXInput.value = adjustments.offsetX;
        offsetYInput.value = adjustments.offsetY;
        zoomInput.value = adjustments.zoom;
        offsetXValue.textContent = adjustments.offsetX;
        offsetYValue.textContent = adjustments.offsetY;
        zoomValue.textContent = adjustments.zoom + '%';
      } else {
        controlsDiv.classList.add('hidden');
      }
    }

    function downloadLayout() {
      const buttonContainer = document.querySelector('.flex.gap-3.pt-4');
      const downloadButton = buttonContainer.querySelector('button:last-child');
      const generateButton = buttonContainer.querySelector('button:first-child');

      const originalDownloadText = downloadButton.textContent;
      downloadButton.textContent = 'Downloading...';
      downloadButton.disabled = true;
      if (generateButton) generateButton.disabled = true;

      try {
        const link = document.createElement('a');
        let formatName;
        if (currentFormat === 'social') {
          formatName = 'post';
        } else if (currentFormat === 'story') {
          formatName = 'story';
        } else {
          formatName = 'website';
        }
        link.download = `${formatName}-layout.webp`;
        link.href = canvas.toDataURL('image/webp', 0.8);

        link.click();

        setTimeout(() => {
          downloadButton.textContent = originalDownloadText;
          downloadButton.disabled = false;
          if (generateButton) generateButton.disabled = false;
        }, 2000);
      } catch (error) {
        console.error("Download failed:", error);
        alert("Image download failed. Please try again.");
        downloadButton.textContent = originalDownloadText;
        downloadButton.disabled = false;
        if (generateButton) generateButton.disabled = false;
      }
    }

    // Control handlers
    document.getElementById('imageOffsetX').addEventListener('input', (e) => {
      if (selectedSlotIndex !== null) {
        if (!imageAdjustments[selectedSlotIndex]) {
          imageAdjustments[selectedSlotIndex] = { offsetX: 0, offsetY: 0, zoom: 100 };
        }
        imageAdjustments[selectedSlotIndex].offsetX = parseInt(e.target.value);
        document.getElementById('imageOffsetXValue').textContent = e.target.value;
        drawLayoutCanvas();
      }
    });

    document.getElementById('imageOffsetY').addEventListener('input', (e) => {
      if (selectedSlotIndex !== null) {
        if (!imageAdjustments[selectedSlotIndex]) {
          imageAdjustments[selectedSlotIndex] = { offsetX: 0, offsetY: 0, zoom: 100 };
        }
        imageAdjustments[selectedSlotIndex].offsetY = parseInt(e.target.value);
        document.getElementById('imageOffsetYValue').textContent = e.target.value;
        drawLayoutCanvas();
      }
    });

    document.getElementById('imageZoom').addEventListener('input', (e) => {
      if (selectedSlotIndex !== null) {
        if (!imageAdjustments[selectedSlotIndex]) {
          imageAdjustments[selectedSlotIndex] = { offsetX: 0, offsetY: 0, zoom: 100 };
        }
        imageAdjustments[selectedSlotIndex].zoom = parseInt(e.target.value);
        document.getElementById('imageZoomValue').textContent = e.target.value + '%';
        drawLayoutCanvas();
      }
    });

    document.getElementById('resetImageControls').addEventListener('click', () => {
      if (selectedSlotIndex !== null) {
        imageAdjustments[selectedSlotIndex] = { offsetX: 0, offsetY: 0, zoom: 100 };
        updateImageControls();
        drawLayoutCanvas();
      }
    });
    document.getElementById('spacingSlider').addEventListener('input', (e) => {
      spacing = parseInt(e.target.value);
      document.getElementById('spacingValue').textContent = spacing;
      drawLayoutCanvas();
    });

    document.getElementById('borderWidthSlider').addEventListener('input', (e) => {
      borderWidth = parseInt(e.target.value);
      document.getElementById('borderWidthValue').textContent = borderWidth;
      drawLayoutCanvas();
    });

    document.getElementById('borderColorPicker').addEventListener('input', (e) => {
      borderColor = e.target.value;
      drawLayoutCanvas();
    });

    document.getElementById('backgroundColorPicker').addEventListener('input', (e) => {
      backgroundColor = e.target.value;
      drawLayoutCanvas();
    });

    document.getElementById('roundedCornersSlider').addEventListener('input', (e) => {
      roundedCorners = parseInt(e.target.value);
      document.getElementById('roundedCornersValue').textContent = roundedCorners;
      drawLayoutCanvas();
    });

    document.getElementById('imageFitSelect').addEventListener('change', (e) => {
      imageFit = e.target.value;
      drawLayoutCanvas();
    });

    // Initialize
    initGridTemplates();
    updateCanvasSize();
    updateImageControls(); // Hide controls initially
  </script>
</body>
</html>
